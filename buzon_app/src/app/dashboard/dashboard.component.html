<div class="container-fluid min-vh-100 bg-light d-flex flex-column">

  <!-- HEADER -->
  <header class="d-flex justify-content-between align-items-center p-3 bg-primary text-white shadow-sm">
    <div class="app-title">
      <span class="h5 mb-0">Buzón Anónimo</span>
    </div>

    <div class="d-flex align-items-center position-relative">
      <!-- ICONO PERFIL -->
      <div class="perfil-icon d-flex justify-content-center align-items-center"
           (click)="togglePerfil($event)">
        <i class="bi bi-person-fill"></i>
      </div>

      <!-- MENÚ PERFIL -->
      <div *ngIf="mostrarPerfil" class="perfil-dropdown position-absolute end-0 mt-2 shadow-sm">
        <div class="perfil-info p-3">
          <div class="fw-bold">{{ user.nombre }}</div>
          <div class="text-muted small">{{ user.correo }}</div>
          <span class="badge rol-badge mt-1">{{ getRolFormateado() }}</span>
          <hr class="my-2">
          <button class="btn btn-logout w-100" (click)="logout()">Cerrar sesión</button>
        </div>
      </div>
    </div>
  </header>

  <!-- DASHBOARD -->
  <div class="container my-4 flex-grow-1">
    <!-- TOP SECTION -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="h4 mb-0">Mis Clases</h2>
      <div class="d-flex gap-2">
        <button *ngIf="esModerador()" class="btn btn-primary btn-sm" (click)="abrirModalCrearClase()">Crear nueva clase</button>
        <button *ngIf="esModerador()" class="btn btn-secondary btn-sm" (click)="abrirModalRegistro()">
          <i class="bi bi-person-fill-add me-1"></i> Registrar usuario
        </button>
        <button *ngIf="!esModerador()" class="btn btn-success btn-sm" (click)="unirseClase()">Unirse a una clase</button>
      </div>
    </div>

    <!-- LISTA DE CLASES -->
    <div *ngIf="clases.length > 0; else noClases">
      <ul class="list-group">
        <li *ngFor="let clase of clases; let i = index" 
            class="list-group-item d-flex justify-content-between align-items-center text-white rounded mb-2 clase-item" 
            [attr.data-index]="i" 
            [ngClass]="clase.colorClase"
            (click)="entrarClase(clase)">
          <div>
            <strong>{{ clase.nombre }}</strong>
          </div>
          <button *ngIf="esModerador()" class="btn btn-transparent p-0" (click)="eliminarClase(clase.id_clase); $event.stopPropagation()">
            <i class="bi bi-trash"></i>
          </button>
        </li>
      </ul>
    </div>

    <ng-template #noClases>
      <div class="text-center text-muted py-5">
        <p>No estás unido a ninguna clase.</p>
      </div>
    </ng-template>

    <div *ngIf="errorMessage" class="text-danger mt-2">{{ errorMessage }}</div>
  </div>

  <!-- MODAL CREAR CLASE -->
  <div class="modal-backdrop d-flex justify-content-center align-items-center" *ngIf="modalCrearClase">
    <div class="bg-white rounded p-4 shadow-sm" style="width: 300px;">
      <h5>Crear Clase</h5>
      <input type="text" class="form-control my-2" placeholder="Nombre de la clase" [(ngModel)]="nuevoNombre">
      <div class="d-flex justify-content-between mt-3">
        <button class="btn btn-primary btn-sm" (click)="crearClase()" [disabled]="!nuevoNombre.trim()">Crear</button>
        <button class="btn btn-secondary btn-sm" (click)="cerrarModalCrearClase()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- MODAL REGISTRO USUARIO -->
  <div class="modal-backdrop d-flex justify-content-center align-items-center" *ngIf="modalRegistro">
    <div class="bg-white rounded p-4 shadow-sm" style="width: 320px;">
      <h5>Registrar Usuario</h5>
      <input type="email" class="form-control my-2" placeholder="Correo @campuscamara.es" [(ngModel)]="nuevoCorreo">
      <div class="input-group my-2">
        <input 
          [type]="mostrarContrasena ? 'text' : 'password'" 
          class="form-control" 
          placeholder="Contraseña" 
          [(ngModel)]="nuevaContrasena">
        <button class="btn btn-outline-secondary" type="button" (click)="toggleMostrarContrasena()">
          <i class="bi" [ngClass]="mostrarContrasena ? 'bi-eye-slash-fill' : 'bi-eye'"></i>
        </button>
      </div>
      <div class="input-group my-2">
        <input 
          [type]="mostrarContrasenaConfirm ? 'text' : 'password'" 
          class="form-control" 
          placeholder="Confirmar contraseña" 
          [(ngModel)]="confirmarContrasena">
        <button class="btn btn-outline-secondary" type="button" (click)="toggleMostrarContrasenaConfirm()">
          <i class="bi" [ngClass]="mostrarContrasenaConfirm ? 'bi-eye-slash-fill' : 'bi-eye'"></i>
        </button>
      </div>
      <label class="form-label mt-2">Rol</label>
      <select class="form-select mb-2" [(ngModel)]="nuevoRol">
        <option value="alumno">Alumno</option>
        <option value="profesor">Profesor</option>
      </select>
      <div *ngIf="registroError" class="text-danger mb-2">{{ registroError }}</div>
      <div class="d-flex justify-content-between mt-3">
        <button class="btn btn-primary btn-sm" (click)="registrarUsuario()" [disabled]="registroLoading">Registrar</button>
        <button class="btn btn-secondary btn-sm" (click)="cerrarModalRegistro()">Cancelar</button>
      </div>
    </div>
  </div>

</div>
